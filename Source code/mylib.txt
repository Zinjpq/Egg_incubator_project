#include <util/delay.h>
#include <avr/io.h>

#define LCD_RS PC0
#define LCD_E PC1
#define LCD_D4 PC2
#define LCD_D5 PC3
#define LCD_D6 PC4
#define LCD_D7 PC5

//HIEN THUC HAM
void adc_init() {
    ADMUX |= (1 << REFS0);
    ADCSRA |= (1 << ADEN) | (1 << ADPS1) | (1 << ADPS0);
}

uint16_t adc_read(uint8_t adc_port) {
    ADMUX = (1 << REFS0) | adc_port;
    ADCSRA |= (1 << ADSC);
    while (ADCSRA & (1 << ADSC)) {
        _delay_ms(1);
    }
    return ADCW;
}

void lcd_command(uint8_t cmd) {
    PORTD = (cmd & 0xF0) | (1 << LCD_E);
    PORTD &= ~(1 << LCD_RS);
    _delay_ms(1);
    PORTD &= ~(1 << LCD_E);
    _delay_ms(1);

    PORTD = ((cmd & 0x0F) << 4) | (1 << LCD_E);
    PORTD &= ~(1 << LCD_RS);
    _delay_ms(1);
    PORTD &= ~(1 << LCD_E);
    _delay_ms(1);
}

void lcd_data(uint8_t data) {
    PORTD = (data & 0xF0) | (1 << LCD_E) | (1 << LCD_RS);
    _delay_ms(1);
    PORTD &= ~(1 << LCD_E);
    _delay_ms(1);

    PORTD = ((data & 0x0F) << 4) | (1 << LCD_E) | (1 << LCD_RS);
    _delay_ms(1);
    PORTD &= ~(1 << LCD_E);
    _delay_ms(1);
}

void lcd_string(const char* str) {
    int i = 0;
    while (str[i] != '\0') {
        lcd_data(str[i]);
        i++;
    }
}

void lcd_string_with_delay(const char* str, int delay_ms) {
    //xóa màn hình
    lcd_command(0x01);
    int i = 0;
    while (str[i] != '\0') {
        if (i == 16) {
            lcd_command(0xC0);  // Di chuyển con trỏ đến dòng thứ hai
        }
        lcd_data(str[i]);
        i++;
        _delay_ms(delay_ms);
    }
}

void lcd_float(float number) {
  char str[10];
  char str_i[10];
  dtostrf(number, 2, 2, str_i);
  snprintf(str, sizeof(str), "%s", str_i);
  lcd_string(str);
}

void lcd_clear() {
    lcd_command(0x01);  // Xóa màn hình LCD
}

void hello(){
  //Lời chào 
  lcd_string_with_delay("    Group 4     EMA3028 20 2024", 10);
  _delay_ms(1000);
  lcd_string_with_delay(" The Incubator", 10);
  _delay_ms(1000);
  lcd_command(0x01);  // Clear display
}

void write_temp(int temp,int temp_set){
  lcd_clear();        // Clear display
  
  lcd_string("Temp: ");
  lcd_float(temp);
  lcd_command(0xC0);  // Di chuyển con trỏ đến dòng thứ hai
  lcd_string("Temp_set=");
  lcd_float(temp_set);
  delay(100);
}

